{"version":3,"sources":["../src/generate_report.js"],"names":["define","$","Ajax","Notification","Str","Url","GenerateReport","requestorId","userId","userName","contextId","parseInt","start","end","timer","file","formdata","polling","click","e","preventDefault","startDate","val","endDate","completion","checkCompletion","icon","attr","imageUrl","alert","get_string","requestorid","userid","username","contextid","call","methodname","args","jsonformdata","JSON","stringify","done","str","addClass","html","prepend","that","setInterval","pollFile","bind","fail","exception","prototype","length","data","status","content","path","removeClass","clearInterval","generateReport"],"mappings":"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","sourcesContent":["define(['jquery',\n        'core/ajax',\n        'core/notification',\n        'core/str',\n        'core/url'], function($, Ajax, Notification, Str, Url) {\n    \"use strict\";\n\n    var GenerateReport = function(requestorId, userId, userName, contextId) {\n        this.requestorId = parseInt(requestorId);\n        this.userId = parseInt(userId);\n        this.userName = userName;\n        this.start = null;\n        this.end = null;\n        this.contextId = contextId;\n        this.timer = 2500;\n        this.file = false;\n        this.formdata = {};\n        this.polling = null;\n\n        $('#submitdate').click(function(e) {\n            e.preventDefault();\n\n            var startDate = $('#startInput').val();\n            var endDate = $('#endInput').val();\n            var completion = this.checkCompletion(startDate, endDate);\n\n            var icon = $('<img/>');\n            icon.attr('alt', 'loading');\n            icon.attr('title', 'loading');\n            icon.attr('class', 'tool_time_report_icon');\n            icon.attr('src', Url.imageUrl('loading', 'tool_time_report'));\n\n            if (!completion) {\n                return Notification.alert(\n                    Str.get_string('error'), \n                    Str.get_string('error:completiondates', 'tool_time_report')\n                );\n            }\n\n            var formdata = {\n                requestorid: this.requestorId,\n                userid: this.userId,\n                username: this.userName,\n                start: $('#startInput').val(),\n                end: $('#endInput').val(),\n                contextid: this.contextId\n            };\n            this.formdata = formdata;\n\n            Ajax.call([{\n                methodname: 'tool_time_report_generate_time_report',\n                args: { jsonformdata: JSON.stringify(formdata) },\n                done: function() {\n                    Str.get_string('client:reportgenerating', 'tool_time_report').done(function(str) {\n                        $('#report-area').addClass('alert-warning')\n                            .html(str).prepend(icon);\n                    });\n                    var that = this;\n                    (function foo() {\n                        that.polling = setInterval(pollFile.bind(that), 7500);\n                    })();\n                }.bind(this),\n                fail: Notification.exception\n            }]);\n        }.bind(this));\n    };\n\n    GenerateReport.prototype.checkCompletion = function(startDate, endDate) {\n        if (startDate.length == 0||endDate.length == 0) {\n            return false;\n        }\n        return true;\n    };\n\n    var pollFile = function() {\n        var icon = $('<img/>');\n        icon.attr('alt', 'download');\n        icon.attr('title', 'download');\n        icon.attr('class', 'tool_time_report_icon');\n        icon.attr('src', Url.imageUrl('download', 'tool_time_report'));\n\n        Ajax.call([{\n            methodname: 'tool_time_report_poll_report_file',\n            args: { jsonformdata: JSON.stringify(this.formdata) },\n            done: function(data) {\n                if (data.status == true) {\n                    Str.get_string('client:reportdownload', 'tool_time_report').done(function(str) {\n                        var content = $('<a href=\"'+data.path+'\" target=\"_blank\">' + str + '</a>').prepend(icon);\n                        $('#report-area').removeClass('alert-warning').addClass('alert-success')\n                            .html(content);\n                    });\n                    clearInterval(this.polling);\n                    return;\n                }\n            }.bind(this),\n            fail: Notification.exception\n        }]);\n    };\n\n    return {\n        generateReport: function(requestorId, userId, userName, contextId) {\n            return new GenerateReport(requestorId, userId, userName, contextId);\n        }\n    };\n});"],"file":"generate_report.min.js"}